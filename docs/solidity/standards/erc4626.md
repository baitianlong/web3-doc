# ERC-4626 金库标准

ERC-4626 是一种用于收益型金库（Vault）的代币化标准，广泛应用于 DeFi 收益聚合、存款凭证等场景。

## 标准简介

- ERC-4626 由以太坊社区提出，编号为 [EIP-4626](https://eips.ethereum.org/EIPS/eip-4626)
- 统一了存款、取款、收益分配等接口，提升 DeFi 互操作性

## 接口定义

```solidity
interface IERC4626 {
    function asset() external view returns (address);
    function totalAssets() external view returns (uint256);
    function convertToShares(uint256 assets) external view returns (uint256);
    function convertToAssets(uint256 shares) external view returns (uint256);
    function maxDeposit(address receiver) external view returns (uint256);
    function previewDeposit(uint256 assets) external view returns (uint256);
    function deposit(uint256 assets, address receiver) external returns (uint256);
    function maxMint(address receiver) external view returns (uint256);
    function previewMint(uint256 shares) external view returns (uint256);
    function mint(uint256 shares, address receiver) external returns (uint256);
    function maxWithdraw(address owner) external view returns (uint256);
    function previewWithdraw(uint256 assets) external view returns (uint256);
    function withdraw(uint256 assets, address receiver, address owner) external returns (uint256);
    function maxRedeem(address owner) external view returns (uint256);
    function previewRedeem(uint256 shares) external view returns (uint256);
    function redeem(uint256 shares, address receiver, address owner) external returns (uint256);
    event Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares);
    event Withdraw(address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares);
}
```

## 主要函数说明

- `deposit`/`withdraw`：存入/取出资产，获得/销毁份额
- `convertToShares`/`convertToAssets`：资产与份额的转换
- `maxDeposit`/`maxWithdraw`：最大可存/取额度
- `previewDeposit`/`previewWithdraw`：预览操作结果

## 实战案例：最简 ERC-4626 实现

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleVault {
    address public asset;
    uint256 public totalAssets;
    uint256 public totalShares;
    mapping(address => uint256) public sharesOf;
    event Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares);
    event Withdraw(address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares);

    constructor(address _asset) { asset = _asset; }

    function deposit(uint256 assets, address receiver) public returns (uint256 shares) {
        // 假设1:1兑换
        shares = assets;
        totalAssets += assets;
        totalShares += shares;
        sharesOf[receiver] += shares;
        emit Deposit(msg.sender, receiver, assets, shares);
    }

    function withdraw(uint256 assets, address receiver, address owner) public returns (uint256 shares) {
        shares = assets;
        require(sharesOf[owner] >= shares, "Insufficient shares");
        totalAssets -= assets;
        totalShares -= shares;
        sharesOf[owner] -= shares;
        emit Withdraw(msg.sender, receiver, owner, assets, shares);
    }
}
```

## 关键点说明

- 统一了 DeFi 金库的存取接口，便于集成和组合
- 事件 Deposit、Withdraw 必须实现
- 生产环境建议用 OpenZeppelin ERC4626
- 需注意资产与份额的兑换逻辑和安全性

## 最佳实践

- 遵循标准接口，确保 DeFi 协议兼容
- 事件参数加 indexed，便于检索
- 充分测试兑换、存取、收益分配等逻辑
- 生产环境建议用 OpenZeppelin ERC4626

---

## 下一步操作

1. **动手实践**：用 OpenZeppelin 部署一个 ERC-4626 金库合约。
2. **进阶挑战**：实现收益分配、复利等高级功能。
3. **深入阅读**：
   - [EIP-4626 标准](https://eips.ethereum.org/EIPS/eip-4626)
   - [OpenZeppelin ERC4626 文档](https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC4626) 